<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <!-- =================================================================================
    BLOCO 1: <HEAD> - CONFIGURAÇÕES E ESTILOS
    ================================================================================== -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRGL - Aprenda Libras</title>
    
    <!-- Carregando o framework Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Carregando a fonte 'Inter' do Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- Estilos CSS customizados -->
    <style>
        /* Define a fonte 'Inter' como padrão para todo o corpo */
        body { font-family: 'Inter', sans-serif; }
        
        /* Classe para o gradiente principal usado na tela inicial */
        .main-gradient { background-image: linear-gradient(to top right, #4f46e5, #6366f1); }
        
        /* Estilização padrão do botão primário (usado em 'Conectar' e 'Próxima Palavra') */
        .btn-primary {
            background-color: #14b8a6; /* Cor teal */
            color: white;
            transition: all 0.3s ease;
        }
        .btn-primary:hover { background-color: #0d9488; } /* Escurece no hover */
        
        /* Efeito de hover para os cartões (lições e botões da home) */
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { 
            transform: translateY(-6px); /* Eleva o cartão */
            box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -4px rgba(0,0,0,.1); /* Sombra mais forte */
        }
    </style>
</head>
<body class="bg-gray-200 flex items-center justify-center min-h-screen">

    <!-- =================================================================================
    BLOCO 2: <BODY> - ESTRUTURA HTML DAS TELAS
    ================================================================================== -->

    <!-- Container principal que simula a tela de um app (limita a largura) -->
    <div class="w-full max-w-sm mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
        <!-- Define uma altura fixa para a "tela" do app -->
        <div class="h-[700px] flex flex-col">

            <!-- 
            -----------------------------------------------------------------
            TELA 1: Início (Home)
            Visível por padrão, escondida pelo JS quando outra tela é mostrada.
            -----------------------------------------------------------------
            -->
            <div id="screenHome" class="flex flex-col h-full p-8 text-center main-gradient text-white">
                <div class="flex-1 flex flex-col items-center justify-center">
                    <!-- Ícone da Luva -->
                    <div class="bg-white/20 p-4 rounded-full mb-6 backdrop-blur-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M18 10V6a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v4"/><path d="M12 10v4"/><path d="M12 18.5a2.5 2.5 0 0 1-5 0V16a2 2 0 0 1 2-2h1a2 2 0 0 1 2 2v2.5a2.5 2.5 0 0 1-5 0V16"/><path d="M12 14h1a2 2 0 0 1 2 2v2.5a2.5 2.5 0 0 0 5 0V16a2 2 0 0 0-2-2h-1"/></svg>
                    </div>
                    <h1 class="text-5xl font-extrabold mb-2">SRGL</h1>
                    <p class="text-indigo-200 mb-12 max-w-xs mx-auto">Sua jornada para aprender Libras começa aqui.</p>
                    
                    <!-- Botões de Navegação -->
                    <div class="w-full flex flex-col space-y-4">
                        <button onclick="showScreen('screenTraducao')" class="w-full bg-white text-indigo-600 font-bold py-4 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-transform duration-300">
                            Modo Tradução
                        </button>
                        <button onclick="showScreen('screenSelecaoLicao')" class="w-full bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-bold py-4 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-transform duration-300">
                            Modo Aprendizagem
                        </button>
                    </div>
                </div>
                <div class="text-xs text-indigo-300 mt-6">Projeto Integrador V</div>
            </div>

            <!-- 
            -----------------------------------------------------------------
            TELA 2: Seleção de Lição
            Escondida por padrão (classe 'hidden').
            -----------------------------------------------------------------
            -->
            <div id="screenSelecaoLicao" class="hidden flex-col h-full p-6 bg-gray-50">
                <!-- Cabeçalho com botão de voltar -->
                <div class="flex items-center mb-6">
                    <button onclick="showScreen('screenHome')" class="text-gray-500 hover:text-indigo-600">&larr; Voltar</button>
                    <h2 class="flex-1 text-center text-2xl font-bold text-gray-800">Lições</h2>
                </div>
                <p class="text-center text-gray-600 mb-6">Escolha uma categoria para começar a praticar.</p>
                
                <!-- Container onde o JS vai injetar os cartões das lições -->
                <div id="licoesContainer" class="flex-1 overflow-y-auto space-y-4 pr-2">
                    <!-- Os cartões são gerados pelo JS (função gerarCartoesLicao) -->
                </div>
            </div>

            <!-- 
            -----------------------------------------------------------------
            TELA 3: Modo Tradução (Conexão com ESP)
            Escondida por padrão (classe 'hidden').
            -----------------------------------------------------------------
            -->
            <div id="screenTraducao" class="hidden flex-col h-full p-6 bg-gray-50">
                 <!-- Cabeçalho com botão de voltar -->
                 <div class="flex items-center mb-4">
                    <button onclick="showScreen('screenHome')" class="text-gray-500 hover:text-indigo-600">&larr; Voltar</button>
                    <h2 class="flex-1 text-center text-2xl font-bold text-gray-800">Tradução</h2>
                </div>
                
                <!-- Input do IP e Botão Conectar -->
                <div class="flex gap-2 mb-4">
                    <input type="text" id="espIpInput" placeholder="IP do ESP32" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button id="connectButton" onclick="toggleConnection()" class="px-5 py-3 btn-primary font-semibold rounded-xl shadow-md">Conectar</button>
                </div>
                
                <!-- Display principal (Status e Gesto "ao vivo") -->
                <div class="flex-1 flex flex-col items-center justify-center bg-white rounded-2xl shadow-inner p-6">
                    <p id="statusTraducao" class="text-lg text-gray-500 font-semibold mb-4">Status: Desconectado</p>
                    <div id="gestoExibido" class="text-9xl font-extrabold text-indigo-600">-</div>
                </div>
                
                <!-- Display da palavra formada -->
                <div class="mt-4 p-4 bg-gray-100 rounded-xl">
                    <div class="flex items-center mb-1">
                        <p class="text-sm text-gray-600 font-medium">Palavra formada:</p>
                        <button onclick="limparPalavra()" class="ml-auto text-sm font-medium text-indigo-600 hover:text-indigo-800">Limpar</button>
                    </div>
                    <p id="palavraFormada" class="text-xl text-gray-800 font-semibold">-</p>
                </div>
            </div>

            <!-- 
            -----------------------------------------------------------------
            TELA 4: Modo Aprendizagem (Desafio)
            Escondida por padrão (classe 'hidden').
            -----------------------------------------------------------------
            -->
            <div id="screenAprendizagem" class="hidden flex-col h-full p-6 bg-gray-50">
                <!-- Cabeçalho com botão de voltar e título da lição -->
                <div class="flex items-center mb-4">
                    <button onclick="showScreen('screenSelecaoLicao')" class="text-gray-500 hover:text-indigo-600">&larr; Voltar</sapan>
                    <h2 id="categoriaTitulo" class="flex-1 text-center text-2xl font-bold text-gray-800">Aprendendo</h2>
                </div>
                
                <!-- Display da Palavra Desafio (com letras coloridas) -->
                <div class="text-center mb-4 p-4 rounded-xl bg-indigo-100">
                    <p class="font-semibold text-indigo-800">Soletrar a palavra:</p>
                    <div id="palavraDesafioContainer" class="text-3xl font-bold text-indigo-600 tracking-widest mt-1">PALAVRA</div>
                </div>
                
                <!-- Display da Letra Alvo e Feedback -->
                <div class="flex-1 flex flex-col items-center justify-center bg-white rounded-2xl shadow-inner p-6 space-y-2">
                    <p class="text-gray-500 text-lg">Faça o gesto para a letra:</p>
                    <div id="letraDesafioLabel" class="text-9xl font-extrabold text-teal-500">?</div>
                    <!-- O feedback muda de cor (CSS) conforme o status (aguardando, certo, errado) -->
                    <div id="feedbackLabel" class="w-full p-3 rounded-lg text-center font-semibold">Aguarde...</div>
                </div>
                
                 <!-- Botão para avançar (escondido até a palavra ser completada) -->
                 <div class="mt-4">
                    <button id="proximaPalavraBtn" onclick="avancarLicao()" class="hidden w-full btn-primary font-bold py-4 px-6 rounded-xl shadow-lg">Próxima Palavra</button>
                </div>
            </div>

        </div> <!-- Fim do container de altura fixa [h-700px] -->
    </div> <!-- Fim do container do app (max-w-sm) -->

    <!-- =================================================================================
    BLOCO 3: JAVASCRIPT - LÓGICA DA APLICAÇÃO
    ================================================================================== -->
    <script>
        // =================================================================================
        // BLOCO 3.1: ESTRUTURA DE DADOS DAS LIÇÕES
        // =================================================================================
        // Define o conteúdo de todas as lições (categorias, ícones, palavras, cores)
        const licoes = [
            {
                categoria: "Cores",
                icone: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10c.34 0 .67-.02 1-.05M12 2c5.52 0 10 4.48 10 10 0 .34-.02.67-.05 1M6.4 17.6A8 8 0 0 0 17.6 6.4"/></svg>`,
                palavras: ["AZUL", "VERDE", "SOL"], // Adicionei 'SOL' como exemplo, já que estava na estrutura
                cor: "bg-blue-500"
            },
            {
                categoria: "Frutas",
                icone: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.56 16.5c-.83 1.33-2.33 2.5-4.56 2.5-1.44 0-2.67-.5-3.5-1.5-.83 1-2.06 1.5-3.5 1.5-2.23 0-3.73-1.17-4.56-2.5A8.2 8.2 0 0 1 2 12.35c0-4.42 3.58-8 8-8 2.22 0 4.22.9 5.66 2.34A8.01 8.01 0 0 1 22 12.35a8.1 8.1 0 0 1-.44 4.15z"/><path d="M16 4.34c-1.44-1.44-3.44-2.34-5.66-2.34-4.42 0-8 3.58-8 8a8.2 8.2 0 0 0 3.44 6.5"/></svg>`,
                palavras: ["UVA", "MACA", "PERA"],
                cor: "bg-red-500"
            },
            {
                categoria: "Animais",
                icone: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.5 20.5v-2M13.5 20.5v-2"/><path d="M15.5 16.5a2 2 0 0 0-1.2-1.8c-1.3-.5-2.8-.5-4.1 0a2 2 0 0 0-1.2 1.8c0 .9.6 1.7 1.5 2h3.1c.9-.3 1.5-1.1 1.5-2Z"/><path d="M12 12.5a2.49 2.49 0 0 0-2.4 2 2.5 2.5 0 0 0 4.9 0 2.49 2.49 0 0 0-2.5-2Z"/><path d="M2 12.83c0-2.82 2.18-5.11 5-5.63a8.8 8.8 0 0 1 10 0c2.82.52 5 2.81 5 5.63V15a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1z"/></svg>`,
                palavras: ["GATO", "CAO", "LEAO"],
                cor: "bg-yellow-500"
            }
        ];
        
        // =================================================================================
        // BLOCO 3.2: VARIÁVEIS GLOBAIS E ELEMENTOS DOM
        // =================================================================================
        
        // Referência a todas as telas para a função showScreen
        const allScreens = ['screenHome', 'screenSelecaoLicao', 'screenTraducao', 'screenAprendizagem'];
        const ipInput = document.getElementById('espIpInput');
        
        // Elementos DOM e variáveis de estado para o Modo Tradução
        const statusLabelTraducao = document.getElementById('statusTraducao');
        const gestoLabel = document.getElementById('gestoExibido');
        const connectButton = document.getElementById('connectButton');
        const palavraLabel = document.getElementById('palavraFormada');
        let isConnected = false;        // Controla o estado da conexão
        let traducaoTimer = null;       // Armazena o timer (setInterval) do fetch "ao vivo"
        let palavraTimer = null;        // Armazena o timer (setInterval) de concatenar a palavra
        let palavraAtualTraducao = "-"; // Armazena a palavra sendo formada

        // Elementos DOM e variáveis de estado para o Modo Aprendizagem
        const licoesContainer = document.getElementById('licoesContainer');
        const categoriaTitulo = document.getElementById('categoriaTitulo');
        const palavraDesafioContainer = document.getElementById('palavraDesafioContainer');
        const letraDesafioLabel = document.getElementById('letraDesafioLabel');
        const feedbackLabel = document.getElementById('feedbackLabel');
        const proximaPalavraBtn = document.getElementById('proximaPalavraBtn');
        // Objeto que rastreia o progresso atual do usuário na lição
        let licaoAtual = { catIndex: 0, palavraIndex: 0, letraIndex: 0 };
        let aprendizagemTimer = null;   // Armazena o timer (setInterval) do fetch de aprendizagem
        let acertouLetraAtual = false;  // Trava a verificação de gestos após um acerto

        // =================================================================================
        // BLOCO 3.3: INICIALIZAÇÃO DA APLICAÇÃO
        // =================================================================================
        
        // Roda assim que a página (DOM) estiver totalmente carregada
        window.onload = () => {
            // Tenta carregar um IP salvo anteriormente no localStorage
            const savedIp = localStorage.getItem('espIpAddress');
            if (savedIp) ipInput.value = savedIp;
            
            // Gera os cartões das lições dinamicamente
            gerarCartoesLicao();
        };

        // Função para criar os cartões de lição na TELA 2
        function gerarCartoesLicao() {
            licoesContainer.innerHTML = ''; // Limpa o container
            // Itera sobre a estrutura de dados 'licoes'
            licoes.forEach((licao, index) => {
                // Adiciona o HTML de cada cartão
                licoesContainer.innerHTML += `
                    <div onclick="iniciarLicao(${index})" class="card-hover flex items-center p-5 rounded-2xl shadow-sm cursor-pointer text-white ${licao.cor}">
                        <div class="mr-4">${licao.icone}</div>
                        <div>
                            <h3 class="font-bold text-lg">${licao.categoria}</h3>
                            <p class="text-sm opacity-80">${licao.palavras.join(', ')}</p>
                        </div>
                        <span class="ml-auto font-bold">&rarr;</span>
                    </div>
                `;
            });
        }
        
        // =================================================================================
        // BLOCO 3.4: NAVEGAÇÃO E CONTROLE GERAL
        // =================================================================================
        
        // Função central para gerenciar a troca de telas
        function showScreen(screenId) {
            // --- LIMPEZA ---
            // Antes de trocar de tela, encerra qualquer processo (timer) que esteja rodando
            if (isConnected) toggleConnection(); // Desconecta o Modo Tradução se estiver ativo
            if (aprendizagemTimer) encerrarLicao(); // Encerra o Modo Aprendizagem se estiver ativo

            // --- NAVEGAÇÃO ---
            // Esconde todas as telas...
            allScreens.forEach(id => document.getElementById(id).classList.add('hidden'));
            // ...e mostra apenas a tela solicitada
            document.getElementById(screenId).classList.remove('hidden');
            
            // --- RESET DE ESTADO (Tradução) ---
            // Se estou indo para a tela de Tradução, garanto que ela esteja no estado inicial
            if (screenId === 'screenTraducao' && ipInput.value.trim() !== '') {
                connectButton.textContent = 'Conectar';
                connectButton.classList.remove('bg-red-500'); // Remove a cor 'vermelha' (de parar)
                statusLabelTraducao.textContent = 'Status: Desconectado';
                isConnected = false; // Garante que o estado lógico seja 'desconectado'
            }
        }
        
        // =================================================================================
        // BLOCO 3.5: MODO TRADUÇÃO
        // =================================================================================
        
        // Controla o botão "Conectar/Parar"
        function toggleConnection() {
            if (isConnected) { 
                // --- AÇÃO: DESCONECTAR ---
                clearInterval(traducaoTimer);   // Para o timer que busca o gesto "ao vivo"
                clearInterval(palavraTimer);    // Para o timer que forma a palavra
                traducaoTimer = null;  
                palavraTimer = null; 
                isConnected = false;
                ipInput.disabled = false; // Libera o campo de IP
                
                // Reseta a UI do botão e status
                connectButton.textContent = 'Conectar';
                connectButton.classList.remove('bg-red-500');
                statusLabelTraducao.textContent = 'Status: Desconectado';
                
            } else { 
                // --- AÇÃO: CONECTAR ---
                const ip = ipInput.value.trim();
                if (!ip) { alert("Por favor, insira um endereço de IP."); return; }
                localStorage.setItem('espIpAddress', ip); // Salva o IP para a próxima vez

                isConnected = true;
                ipInput.disabled = true; // Trava o campo de IP
                
                // --- LÓGICA DE DOIS TIMERS ---
                // Timer 1: Busca o gesto "ao vivo" (feedback rápido, 1.2s)
                traducaoTimer = setInterval(fetchGestoTraducao, 1200); 
                // Timer 2: Captura a letra para a palavra (feedback lento, 4s)
                palavraTimer = setInterval(concatenarLetra, 4000);

                // Atualiza a UI do botão e status
                connectButton.textContent = 'Parar';
                connectButton.classList.add('bg-red-500'); // Botão fica vermelho
                statusLabelTraducao.textContent = 'Status: Conectando...';
                
                fetchGestoTraducao(); // Chama a função imediatamente na primeira vez
            }
        }

        // Função chamada pelo Timer 1 (a cada 1.2s)
        async function fetchGestoTraducao() {
            try {
                // Faz a requisição HTTP GET para o ESP32
                const response = await fetch(`http://${ipInput.value}/gesto`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const letra = await response.text();
                
                // Se deu certo, atualiza o status e o gesto "ao vivo"
                statusLabelTraducao.textContent = 'Status: Conectado';
                gestoLabel.textContent = letra; // Mostra a letra (A, B, C, ou ?)

                // A lógica de formar a palavra foi movida para 'concatenarLetra'
                
            } catch (error) {
                // Se falhar a comunicação
                console.error("Falha na comunicação (Tradução):", error);
                statusLabelTraducao.textContent = 'Status: Erro de Conexão. Tentando novamente...';
                gestoLabel.textContent = '!'; // Mostra '!' para indicar erro
                // O timer continua rodando, tentando reconectar automaticamente
            }
        }

        // Reseta a palavra formada
        function limparPalavra() {
            palavraAtualTraducao = "-";
            palavraLabel.textContent = palavraAtualTraducao;
        }

        // Função chamada pelo Timer 2 (a cada 4s)
        function concatenarLetra() {
            // Pega a letra que o 'fetchGestoTraducao' (Timer 1) deixou visível
            const letra = gestoLabel.textContent;

            // Não adiciona à palavra se for um símbolo de status (erro, desconectado, ou '?')
            if (letra === '-' || letra === '!' || letra === '?') {
                return;
            }

            // Se for a primeira letra, substitui o '-'
            if (palavraAtualTraducao === "-") {
                palavraAtualTraducao = letra;
            } else {
                // Senão, concatena
                palavraAtualTraducao += letra;
            }
            palavraLabel.textContent = palavraAtualTraducao;
        }

        // =================================================================================
        // BLOCO 3.6: MODO APRENDIZAGEM
        // =================================================================================
        
        // Chamada ao clicar em um cartão de lição
        function iniciarLicao(catIndex) {
            // Verifica se o IP está configurado (obrigatório para este modo)
            const ip = ipInput.value.trim();
            if (!ip) {
                alert("Por favor, insira um IP na tela de Tradução antes de iniciar uma lição.");
                return;
            }

            // Define o estado inicial da lição
            licaoAtual = { catIndex, palavraIndex: 0, letraIndex: 0 };
            categoriaTitulo.textContent = licoes[catIndex].categoria; // Atualiza o título
            proximaPalavraBtn.classList.add('hidden'); // Esconde o botão de avançar
            
            showScreen('screenAprendizagem'); // Vai para a tela de aprendizagem

            // Prepara a UI para o primeiro desafio
            apresentarDesafio();

            // Inicia o loop (timer) para verificar o gesto do usuário
            aprendizagemTimer = setInterval(fetchGestoAprendizagem, 1200);
        }

        // Atualiza a UI com o desafio (palavra/letra) atual
        function apresentarDesafio() {
            acertouLetraAtual = false; // Reseta a trava de acerto
            const { catIndex, palavraIndex, letraIndex } = licaoAtual;
            const palavra = licoes[catIndex].palavras[palavraIndex];
            const letra = palavra[letraIndex]; // Letra que o usuário deve fazer

            // --- Lógica para colorir as letras da palavra desafio ---
            // Mapeia a palavra: letras antes do índice atual ficam verdes (teal),
            // o restante fica cinza.
            palavraDesafioContainer.innerHTML = palavra.split('').map((char, index) => 
                `<span class="${index < letraIndex ? 'text-teal-500' : 'text-gray-400'}">${char}</span>`
            ).join('');
            // --------------------------------------------------------

            letraDesafioLabel.textContent = letra; // Mostra a letra alvo
            
            // Reseta o feedback para "Aguardando" (cor amarela)
            feedbackLabel.textContent = 'Aguardando seu gesto...';
            feedbackLabel.className = 'w-full p-3 rounded-lg text-center font-semibold text-yellow-800 bg-yellow-100';
        }

        // Função chamada pelo Timer de Aprendizagem (a cada 1.2s)
        async function fetchGestoAprendizagem() {
            // Se o usuário acabou de acertar, 'acertouLetraAtual' será true.
            // Isso pausa a verificação para ele ter tempo de ler o feedback "Correto!".
            if (acertouLetraAtual) return; 

            try {
                // Faz a requisição HTTP GET para o ESP32
                const response = await fetch(`http://${ipInput.value}/gesto`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const letraRecebida = await response.text();
                
                // Se a requisição foi bem-sucedida (após um erro, por exemplo),
                // reseta o status para "Aguardando..."
                if (feedbackLabel.textContent.includes('Erro de Conexão')) {
                    feedbackLabel.textContent = 'Aguardando seu gesto...';
                    feedbackLabel.className = 'w-full p-3 rounded-lg text-center font-semibold text-yellow-800 bg-yellow-100';
                }

                // Só verifica o gesto se não for '?'
                if (letraRecebida !== '?') {
                    verificarGesto(letraRecebida);
                }
            } catch (error) {
                console.error("Falha na comunicação (Aprendizagem):", error);
                // Se falhar a conexão, avisa na UI (cor vermelha)
                feedbackLabel.textContent = 'Erro de Conexão. Verifique o IP ou a luva.';
                feedbackLabel.className = 'w-full p-3 rounded-lg text-center font-semibold text-red-800 bg-red-100';
                // O timer continua ativo, tentando reconectar/fetch a cada 1.2s
            }
        }

        // Compara o gesto recebido com a letra correta
        function verificarGesto(letraRecebida) {
            const { catIndex, palavraIndex, letraIndex } = licaoAtual;
            const palavra = licoes[catIndex].palavras[palavraIndex];
            const letraCorreta = palavra[letraIndex];

            if (letraRecebida === letraCorreta) {
                // --- ACERTOU ---
                acertouLetraAtual = true; // Trava o 'fetchGestoAprendizagem'
                feedbackLabel.textContent = 'Correto!';
                feedbackLabel.className = 'w-full p-3 rounded-lg text-center font-semibold text-green-800 bg-green-100';
                licaoAtual.letraIndex++; // Avança para a próxima letra

                // Atualiza a palavra desafio (colore a letra que acabou de acertar)
                palavraDesafioContainer.innerHTML = palavra.split('').map((char, index) => 
                    `<span class="${index < licaoAtual.letraIndex ? 'text-teal-500' : 'text-gray-400'}">${char}</span>`
                ).join('');

                // Espera 1 segundo (1000ms) antes de avançar
                setTimeout(() => {
                    if (licaoAtual.letraIndex >= palavra.length) { 
                        // --- PALAVRA COMPLETA ---
                        feedbackLabel.textContent = 'Palavra completa!';
                        proximaPalavraBtn.classList.remove('hidden'); // Mostra o botão "Próxima Palavra"
                        clearInterval(aprendizagemTimer); // PAUSA o timer de verificação
                        aprendizagemTimer = null; 
                    } else { 
                        // --- PRÓXIMA LETRA ---
                        apresentarDesafio(); // Prepara a UI para a próxima letra
                        // 'acertouLetraAtual' foi resetado para 'false' dentro de 'apresentarDesafio'
                    }
                }, 1000); // Delay de 1s para o usuário ver o feedback "Correto!"
                
            } else {
                // --- ERROU ---
                feedbackLabel.textContent = `Incorreto. Tente a letra "${letraCorreta}" novamente.`;
                feedbackLabel.className = 'w-full p-3 rounded-lg text-center font-semibold text-red-800 bg-red-100';
                // O loop continua, pois 'acertouLetraAtual' ainda é 'false'
            }
        }

        // Chamado pelo botão "Próxima Palavra"
        function avancarLicao() {
            proximaPalavraBtn.classList.add('hidden'); // Esconde o botão
            licaoAtual.palavraIndex++; // Avança para a próxima palavra
            licaoAtual.letraIndex = 0; // Reseta o contador de letras
            
            const { catIndex, palavraIndex } = licaoAtual;
            
            // Verifica se a lição terminou
            if (palavraIndex >= licoes[catIndex].palavras.length) { 
                // --- LIÇÃO COMPLETA ---
                showScreen('screenSelecaoLicao'); // Volta para a tela de seleção
                alert('Parabéns! Você completou esta lição!');
            } else {
                // --- PRÓXIMA PALAVRA ---
                apresentarDesafio(); // Prepara a UI para a nova palavra
                
                // Reinicia o timer (que foi parado em 'verificarGesto' quando a palavra terminou)
                if (!aprendizagemTimer) {
                    aprendizagemTimer = setInterval(fetchGestoAprendizagem, 1200);
                }
            }
        }

        // Função de limpeza, chamada pelo 'showScreen' ao sair da tela de aprendizagem
        function encerrarLicao() {
            clearInterval(aprendizagemTimer);
            aprendizagemTimer = null; // Garante que o timer seja limpo
            // Reseta o feedback (para não mostrar "Erro" se eu sair da tela)
            feedbackLabel.textContent = 'Aguarde...'; 
            feedbackLabel.className = 'w-full p-3 rounded-lg text-center font-semibold';
        }
    </script>
</body>
</html>
